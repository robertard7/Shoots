<Window x:Class="Shoots.UI.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:converters="clr-namespace:Shoots.UI.Converters"
        Title="{Binding WindowTitle}" Height="640" Width="860">
  <Window.Resources>
    <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
    <converters:NullToVisibilityConverter x:Key="NullToVisibilityConverter" />
  </Window.Resources>
  <Grid Margin="24">
    <Grid.ColumnDefinitions>
      <ColumnDefinition Width="220" />
      <ColumnDefinition Width="*" />
    </Grid.ColumnDefinitions>
    <StackPanel Grid.Column="0" Margin="0,0,16,0">
      <TextBlock Text="Project Workspace" FontWeight="SemiBold" ToolTip="{Binding WorkspaceIsolationTooltip}" />
      <Button Margin="0,8,0,0" Content="New Project" IsEnabled="False" ToolTip="Project creation is coming later" />
      <TextBlock Margin="0,16,0,0" Text="Recent Projects" FontWeight="SemiBold" />
      <ListBox ItemsSource="{Binding RecentWorkspaces}"
               SelectedItem="{Binding SelectedWorkspace, Mode=TwoWay}"
               DisplayMemberPath="Name"
               Margin="0,8,0,0">
        <ListBox.ContextMenu>
          <ContextMenu DataContext="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource Self}}">
            <MenuItem Header="Remove from list"
                      Command="{Binding RemoveWorkspaceCommand}"
                      CommandParameter="{Binding SelectedWorkspace}" />
            <MenuItem Header="Open folder"
                      Command="{Binding OpenWorkspaceCommand}"
                      CommandParameter="{Binding SelectedWorkspace}" />
          </ContextMenu>
        </ListBox.ContextMenu>
        <ListBox.ItemContainerStyle>
          <Style TargetType="ListBoxItem">
            <Setter Property="Padding" Value="6,4" />
            <Setter Property="Margin" Value="0,2,0,0" />
            <Style.Triggers>
              <Trigger Property="IsSelected" Value="True">
                <Setter Property="FontWeight" Value="SemiBold" />
                <Setter Property="Foreground" Value="#FF2B6CB0" />
              </Trigger>
            </Style.Triggers>
          </Style>
        </ListBox.ItemContainerStyle>
      </ListBox>
      <TextBlock Margin="0,8,0,0"
                 Text="No recent projects yet."
                 Foreground="#FF6B7280"
                 Visibility="{Binding HasNoWorkspaces, Converter={StaticResource BooleanToVisibilityConverter}}" />
      <TextBlock Margin="0,8,0,0"
                 Text="Select a project to preview workspace scripts."
                 Foreground="#FF6B7280"
                 Visibility="{Binding HasNoActiveWorkspace, Converter={StaticResource BooleanToVisibilityConverter}}" />
      <TextBlock Margin="0,16,0,0" Text="{Binding ActiveWorkspaceName}" />
      <GroupBox Margin="0,12,0,0" Header="Tool Tier">
        <StackPanel Margin="8">
          <Border Background="#FFEFF6FF" CornerRadius="4" Padding="6">
            <TextBlock Text="{Binding ActiveToolpackTierLabel}"
                       ToolTip="{Binding ActiveToolpackTierTooltip}" />
          </Border>
          <TextBlock Margin="0,6,0,0"
                     Foreground="#FF6B7280"
                     Text="{Binding SystemTierNote}"
                     TextWrapping="Wrap" />
          <ComboBox Margin="0,6,0,0"
                    ItemsSource="{Binding ToolpackTierOptions}"
                    SelectedItem="{Binding SelectedToolpackTier}"
                    IsEnabled="{Binding CanSelectToolpackTier}" />
          <Button Margin="0,6,0,0"
                  Content="{Binding SystemTierActionLabel}"
                  Command="{Binding ToggleSystemTierCommand}"
                  ToolTip="{Binding ActiveToolpackTierTooltip}"
                  ToolTipService.ShowOnDisabled="True"
                  IsEnabled="{Binding HasActiveWorkspace}" />
        </StackPanel>
      </GroupBox>
      <GroupBox Margin="0,12,0,0" Header="Role">
        <StackPanel Margin="8">
          <ComboBox ItemsSource="{Binding RoleOptions}"
                    SelectedItem="{Binding SelectedRole}"
                    DisplayMemberPath="Name"
                    IsEnabled="{Binding HasActiveWorkspace}" />
          <TextBlock Margin="0,6,0,0"
                     Foreground="#FF6B7280"
                     Text="{Binding SelectedRoleDescription}"
                     TextWrapping="Wrap" />
        </StackPanel>
      </GroupBox>
    </StackPanel>
    <TabControl Grid.Column="1">
      <TabItem Header="Execution">
        <Grid Margin="16">
          <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
          </Grid.RowDefinitions>
          <Border Background="#FFEFF6FF" Padding="12" CornerRadius="4">
            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
              <TextBlock Text="Execution State:" FontWeight="SemiBold" />
              <TextBlock Text="{Binding StateLabel}" Margin="8,0,0,0" />
              <TextBlock Text="Replay Mode" Margin="16,0,0,0"
                         ToolTip="Replay mode is read-only and trace-backed."
                         Visibility="{Binding IsReplayMode, Converter={StaticResource BooleanToVisibilityConverter}}" />
            </StackPanel>
          </Border>
          <StackPanel Grid.Row="1" Margin="0,16,0,0" Orientation="Horizontal" HorizontalAlignment="Left">
            <Button Width="110"
                    Content="Start"
                    Command="{Binding StartCommand}"
                    ToolTip="{Binding StartDisabledReason}"
                    ToolTipService.ShowOnDisabled="True" />
            <Button Width="110" Margin="8,0,0,0" Content="Cancel" Command="{Binding CancelCommand}" />
            <Button Width="140" Margin="8,0,0,0" Content="Refresh Status" Command="{Binding RefreshStatusCommand}" />
            <Button Width="140"
                    Margin="8,0,0,0"
                    Content="Explain Execution"
                    Command="{Binding ExplainExecutionCommand}"
                    ToolTip="Describe execution context using AI Help."
                    Visibility="{Binding CanRenderAiExplainButtons, Converter={StaticResource BooleanToVisibilityConverter}}" />
          </StackPanel>
          <StackPanel Grid.Row="2" Margin="0,24,0,0">
            <TextBlock Text="{Binding ExecutionModeSummary}" FontWeight="SemiBold" />
            <TextBlock Margin="0,4,0,0" Text="{Binding ExecutionProviderSummary}" />
            <TextBlock Margin="0,4,0,0" Text="{Binding ExecutionGraphSummary}" TextWrapping="Wrap" />
            <TextBlock Margin="0,6,0,0"
                       Foreground="#FF6B7280"
                       Text="{Binding ExecutionDisabledReason}"
                       TextWrapping="Wrap" />
            <GroupBox Margin="0,12,0,0" Header="Resolved Steps">
              <ListBox Margin="8" ItemsSource="{Binding ExecutionPlanSteps}">
                <ListBox.ItemTemplate>
                  <DataTemplate>
                    <StackPanel Margin="0,4,0,4">
                      <StackPanel Orientation="Horizontal">
                        <TextBlock Text="{Binding Description}" FontWeight="SemiBold" />
                        <Border Margin="8,0,0,0" Background="{Binding OwnerColor}" CornerRadius="4" Padding="4,1">
                          <TextBlock Foreground="White"
                                     Text="{Binding OwnerLabel}"
                                     ToolTip="{Binding OwnerHint}" />
                        </Border>
                      </StackPanel>
                      <TextBlock Foreground="#FF6B7280"
                                 Text="{Binding Id}"
                                 TextWrapping="Wrap" />
                    </StackPanel>
                  </DataTemplate>
                </ListBox.ItemTemplate>
              </ListBox>
            </GroupBox>
          </StackPanel>
        </Grid>
      </TabItem>
      <TabItem Header="AI Help">
        <Grid Margin="16">
          <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
          </Grid.RowDefinitions>
          <StackPanel>
            <GroupBox Header="AI Visibility Policy"
                      Visibility="{Binding CanConfigureAiPolicy, Converter={StaticResource BooleanToVisibilityConverter}}">
              <StackPanel Margin="12">
                <TextBlock Foreground="#FF6B7280"
                           Text="Policy controls AI visibility without disabling the AI substrate."
                           TextWrapping="Wrap" />
                <StackPanel Margin="0,8,0,0" Orientation="Horizontal">
                  <TextBlock Width="160" Text="Access Role" VerticalAlignment="Center" />
                  <ComboBox Width="220"
                            ItemsSource="{Binding AiAccessRoles}"
                            SelectedItem="{Binding SelectedAiAccessRole}" />
                </StackPanel>
                <StackPanel Margin="0,8,0,0" Orientation="Horizontal">
                  <TextBlock Width="160" Text="Visibility Mode" VerticalAlignment="Center" />
                  <ComboBox Width="220"
                            ItemsSource="{Binding AiVisibilityModes}"
                            SelectedItem="{Binding SelectedAiVisibilityMode}"
                            IsEnabled="{Binding CanToggleAiVisibility}" />
                </StackPanel>
                <StackPanel Margin="0,8,0,0" Orientation="Horizontal">
                  <CheckBox Content="Allow AI panel toggle"
                            IsChecked="{Binding AllowAiPanelToggle}" />
                </StackPanel>
                <StackPanel Margin="0,6,0,0" Orientation="Horizontal">
                  <CheckBox Content="Allow copy/export"
                            IsChecked="{Binding AllowCopyExport}" />
                </StackPanel>
                <StackPanel Margin="0,6,0,0" Orientation="Horizontal">
                  <CheckBox Content="Enterprise mode (hide AI for end users)"
                            IsChecked="{Binding EnterpriseMode}" />
                </StackPanel>
              </StackPanel>
            </GroupBox>
            <TextBlock Margin="0,8,0,0"
                       Foreground="#FF6B7280"
                       Text="{Binding AiPanelVisibilityNote}"
                       TextWrapping="Wrap" />
            <TextBlock Margin="0,6,0,0"
                       Foreground="#FFB91C1C"
                       Text="{Binding AiExportNotice}"
                       TextWrapping="Wrap"
                       Visibility="{Binding IsCopyExportDisabled, Converter={StaticResource BooleanToVisibilityConverter}}" />
            <Border Margin="0,6,0,0"
                    Background="#FFFDE68A"
                    CornerRadius="4"
                    Padding="6"
                    Visibility="{Binding ShowAdminOnlyWatermark, Converter={StaticResource BooleanToVisibilityConverter}}">
              <TextBlock Text="{Binding AiVisibilityWatermark}" Foreground="#FF92400E" />
            </Border>
            <Border Margin="0,8,0,0"
                    Background="#FFEFF6FF"
                    CornerRadius="4"
                    Padding="10"
                    Visibility="{Binding CanRenderAiProviderStatus, Converter={StaticResource BooleanToVisibilityConverter}}">
              <TextBlock Text="{Binding AiProviderStatus}" />
            </Border>
          </StackPanel>
          <Grid Grid.Row="1" Margin="0,12,0,0">
            <StackPanel Visibility="{Binding CanRenderAiPanel, Converter={StaticResource BooleanToVisibilityConverter}}">
              <Border Background="#FFFDF4D7" CornerRadius="4" Padding="10">
                <TextBlock Text="Informational assistance only." FontWeight="SemiBold" />
              </Border>
              <StackPanel Margin="0,12,0,0">
                <Button Width="160"
                        Content="Refresh AI Help"
                        Command="{Binding RefreshAiHelpCommand}"
                        ToolTip="{Binding AiHelpDisabledReason}"
                        ToolTipService.ShowOnDisabled="True" />
                <GroupBox Header="Context Summary" Margin="0,12,0,0">
                  <TextBlock Margin="12" Text="{Binding AiHelpContextSummary}" TextWrapping="Wrap" />
                </GroupBox>
                <GroupBox Header="State Explanation" Margin="0,12,0,0">
                  <TextBlock Margin="12" Text="{Binding AiHelpStateExplanation}" TextWrapping="Wrap" />
                </GroupBox>
                <GroupBox Header="Suggested Next Steps" Margin="0,12,0,0">
                  <TextBlock Margin="12" Text="{Binding AiHelpNextSteps}" TextWrapping="Wrap" />
                </GroupBox>
                <TextBlock Margin="0,12,0,0"
                           Foreground="#FF6B7280"
                           Text="AI Help is descriptive and does not execute actions."
                           TextWrapping="Wrap" />
              </StackPanel>
            </StackPanel>
            <Border Background="#FFF3F4F6"
                    CornerRadius="4"
                    Padding="12"
                    Visibility="{Binding IsAiPanelHidden, Converter={StaticResource BooleanToVisibilityConverter}}">
              <TextBlock Text="AI surfaces are active, but the panel is hidden by policy." TextWrapping="Wrap" />
            </Border>
          </Grid>
        </Grid>
      </TabItem>
      <TabItem Header="Blueprints">
        <Grid Margin="16">
          <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
          </Grid.RowDefinitions>
          <StackPanel>
            <TextBlock Text="Blueprints capture ordered intents and expected artifacts." TextWrapping="Wrap" />
            <TextBlock Margin="0,6,0,0"
                       Foreground="#FF6B7280"
                       Text="{Binding BlueprintStatusNote}"
                       TextWrapping="Wrap" />
            <TextBlock Margin="0,6,0,0"
                       Foreground="#FF1F2937"
                       Text="{Binding BlueprintSaveStatus}"
                       TextWrapping="Wrap" />
          </StackPanel>
          <Grid Grid.Row="1" Margin="0,12,0,0">
            <Grid.ColumnDefinitions>
              <ColumnDefinition Width="*" />
              <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>
            <StackPanel Margin="0,0,12,0">
              <GroupBox Header="Register Blueprint" IsEnabled="{Binding CanManageBlueprints}">
                <StackPanel Margin="12">
                  <StackPanel Orientation="Horizontal">
                    <TextBlock Text="Name" />
                    <Border Margin="8,0,0,0" Background="#FFE5E7EB" CornerRadius="4" Padding="4,1">
                      <TextBlock Foreground="#FF374151" Text="Metadata Only" />
                    </Border>
                  </StackPanel>
                  <TextBox Margin="0,4,0,0" Text="{Binding NewBlueprintName, UpdateSourceTrigger=PropertyChanged}" />
                  <StackPanel Margin="0,8,0,0" Orientation="Horizontal">
                    <TextBlock Text="Description" />
                    <Border Margin="8,0,0,0" Background="#FFE5E7EB" CornerRadius="4" Padding="4,1">
                      <TextBlock Foreground="#FF374151" Text="Metadata Only" />
                    </Border>
                  </StackPanel>
                  <TextBox Margin="0,4,0,0" Text="{Binding NewBlueprintDescription}" TextWrapping="Wrap" Height="60" />
                  <StackPanel Margin="0,8,0,0" Orientation="Horizontal">
                    <TextBlock Text="Version" />
                    <Border Margin="8,0,0,0" Background="#FFE5E7EB" CornerRadius="4" Padding="4,1">
                      <TextBlock Foreground="#FF374151" Text="Metadata Only" />
                    </Border>
                  </StackPanel>
                  <TextBox Margin="0,4,0,0" Text="{Binding NewBlueprintVersion, UpdateSourceTrigger=PropertyChanged}" />
                  <StackPanel Margin="0,8,0,0" Orientation="Horizontal">
                    <TextBlock Text="Definition (JSON or YAML)" />
                    <Border Margin="8,0,0,0" Background="#FFDBEAFE" CornerRadius="4" Padding="4,1">
                      <TextBlock Foreground="#FF1D4ED8" Text="Affects Plan" />
                    </Border>
                  </StackPanel>
                  <TextBox Margin="0,4,0,0" Text="{Binding NewBlueprintDefinition, UpdateSourceTrigger=PropertyChanged}" AcceptsReturn="True" Height="120" />
                  <StackPanel Margin="0,8,0,0" Orientation="Horizontal">
                    <TextBlock Text="Intents (one per line)" />
                    <Border Margin="8,0,0,0" Background="#FFDBEAFE" CornerRadius="4" Padding="4,1">
                      <TextBlock Foreground="#FF1D4ED8" Text="Affects Plan" />
                    </Border>
                  </StackPanel>
                  <TextBox Margin="0,4,0,0" Text="{Binding NewBlueprintIntents}" AcceptsReturn="True" Height="80" />
                  <StackPanel Margin="0,8,0,0" Orientation="Horizontal">
                    <TextBlock Text="Expected artifacts (one per line)" />
                    <Border Margin="8,0,0,0" Background="#FFDBEAFE" CornerRadius="4" Padding="4,1">
                      <TextBlock Foreground="#FF1D4ED8" Text="Affects Plan" />
                    </Border>
                  </StackPanel>
                  <TextBox Margin="0,4,0,0" Text="{Binding NewBlueprintArtifacts}" AcceptsReturn="True" Height="80" />
                  <Button Margin="0,12,0,0"
                          Content="Add Blueprint"
                          Command="{Binding AddBlueprintCommand}"
                          IsEnabled="{Binding CanManageBlueprints}" />
                </StackPanel>
              </GroupBox>
            </StackPanel>
            <GroupBox Grid.Column="1" Header="Registered Blueprints">
              <ListBox Margin="8" ItemsSource="{Binding Blueprints}">
                <ListBox.ItemTemplate>
                  <DataTemplate>
                    <StackPanel Margin="0,4,0,4">
                      <StackPanel Orientation="Horizontal">
                        <TextBlock Text="Blueprint" FontWeight="SemiBold" />
                        <Border Margin="8,0,0,0" CornerRadius="4" Padding="4,1">
                          <Border.Style>
                            <Style TargetType="Border">
                              <Setter Property="Background" Value="#FFE5E7EB" />
                              <Style.Triggers>
                                <DataTrigger Binding="{Binding IsDirty}" Value="True">
                                  <Setter Property="Background" Value="#FFFDE68A" />
                                </DataTrigger>
                              </Style.Triggers>
                            </Style>
                          </Border.Style>
                          <TextBlock Text="{Binding DirtyStateLabel}">
                            <TextBlock.Style>
                              <Style TargetType="TextBlock">
                                <Setter Property="Foreground" Value="#FF374151" />
                                <Style.Triggers>
                                  <DataTrigger Binding="{Binding IsDirty}" Value="True">
                                    <Setter Property="Foreground" Value="#FF92400E" />
                                  </DataTrigger>
                                </Style.Triggers>
                              </Style>
                            </TextBlock.Style>
                          </TextBlock>
                        </Border>
                      </StackPanel>
                      <StackPanel Margin="0,8,0,0" Orientation="Horizontal">
                        <TextBlock Text="Name" FontWeight="SemiBold" />
                        <Border Margin="8,0,0,0" Background="#FFE5E7EB" CornerRadius="4" Padding="4,1">
                          <TextBlock Foreground="#FF374151" Text="Metadata Only" />
                        </Border>
                      </StackPanel>
                      <TextBox Margin="0,4,0,0" Text="{Binding Name, UpdateSourceTrigger=PropertyChanged}" />
                      <StackPanel Margin="0,8,0,0" Orientation="Horizontal">
                        <TextBlock Text="Description" />
                        <Border Margin="8,0,0,0" Background="#FFE5E7EB" CornerRadius="4" Padding="4,1">
                          <TextBlock Foreground="#FF374151" Text="Metadata Only" />
                        </Border>
                      </StackPanel>
                      <TextBox Margin="0,4,0,0" Text="{Binding Description, UpdateSourceTrigger=PropertyChanged}" TextWrapping="Wrap" Height="60" />
                      <StackPanel Margin="0,8,0,0" Orientation="Horizontal">
                        <TextBlock Text="Version" />
                        <Border Margin="8,0,0,0" Background="#FFE5E7EB" CornerRadius="4" Padding="4,1">
                          <TextBlock Foreground="#FF374151" Text="Metadata Only" />
                        </Border>
                      </StackPanel>
                      <TextBox Margin="0,4,0,0" Text="{Binding Version, UpdateSourceTrigger=PropertyChanged}" />
                      <StackPanel Margin="0,8,0,0" Orientation="Horizontal">
                        <TextBlock Text="Definition (JSON or YAML)" />
                        <Border Margin="8,0,0,0" Background="#FFDBEAFE" CornerRadius="4" Padding="4,1">
                          <TextBlock Foreground="#FF1D4ED8" Text="Affects Plan" />
                        </Border>
                      </StackPanel>
                      <TextBox Margin="0,4,0,0" Text="{Binding DefinitionText, UpdateSourceTrigger=PropertyChanged}" AcceptsReturn="True" Height="120" />
                      <StackPanel Margin="0,8,0,0" Orientation="Horizontal">
                        <TextBlock Text="Intents (one per line)" />
                        <Border Margin="8,0,0,0" Background="#FFDBEAFE" CornerRadius="4" Padding="4,1">
                          <TextBlock Foreground="#FF1D4ED8" Text="Affects Plan" />
                        </Border>
                      </StackPanel>
                      <TextBox Margin="0,4,0,0" Text="{Binding IntentsText, UpdateSourceTrigger=PropertyChanged}" AcceptsReturn="True" Height="80" />
                      <StackPanel Margin="0,8,0,0" Orientation="Horizontal">
                        <TextBlock Text="Expected artifacts (one per line)" />
                        <Border Margin="8,0,0,0" Background="#FFDBEAFE" CornerRadius="4" Padding="4,1">
                          <TextBlock Foreground="#FF1D4ED8" Text="Affects Plan" />
                        </Border>
                      </StackPanel>
                      <TextBox Margin="0,4,0,0" Text="{Binding ArtifactsText, UpdateSourceTrigger=PropertyChanged}" AcceptsReturn="True" Height="80" />
                      <Border Margin="0,8,0,0" Background="#FFFEE2E2" CornerRadius="4" Padding="6"
                              Visibility="{Binding HasValidationErrors, Converter={StaticResource BooleanToVisibilityConverter}}">
                        <TextBlock Foreground="#FFB91C1C" Text="{Binding ValidationSummary}" TextWrapping="Wrap" />
                      </Border>
                      <StackPanel Margin="0,8,0,0" Orientation="Horizontal">
                        <Button Width="100"
                                Content="Save"
                                Command="{Binding DataContext.SaveBlueprintCommand, RelativeSource={RelativeSource AncestorType=ListBox}}"
                                CommandParameter="{Binding}"
                                IsEnabled="{Binding CanSave}" />
                        <Button Width="100"
                                Margin="8,0,0,0"
                                Content="Revert"
                                Command="{Binding DataContext.RevertBlueprintCommand, RelativeSource={RelativeSource AncestorType=ListBox}}"
                                CommandParameter="{Binding}"
                                IsEnabled="{Binding CanRevert}" />
                      </StackPanel>
                      <StackPanel Margin="0,8,0,0" Orientation="Horizontal">
                        <Button Width="120"
                                Content="Explain"
                                Command="{Binding DataContext.ExplainBlueprintCommand, RelativeSource={RelativeSource AncestorType=ListBox}}"
                                CommandParameter="{Binding}"
                                Visibility="{Binding DataContext.CanRenderAiExplainButtons, RelativeSource={RelativeSource AncestorType=ListBox}, Converter={StaticResource BooleanToVisibilityConverter}}" />
                        <Button Width="120"
                                Margin="8,0,0,0"
                                Content="Validate"
                                Command="{Binding DataContext.ValidateBlueprintCommand, RelativeSource={RelativeSource AncestorType=ListBox}}"
                                CommandParameter="{Binding}"
                                Visibility="{Binding DataContext.CanRenderAiExplainButtons, RelativeSource={RelativeSource AncestorType=ListBox}, Converter={StaticResource BooleanToVisibilityConverter}}" />
                        <Button Width="120"
                                Margin="8,0,0,0"
                                Content="Suggest"
                                Command="{Binding DataContext.SuggestBlueprintCommand, RelativeSource={RelativeSource AncestorType=ListBox}}"
                                CommandParameter="{Binding}"
                                Visibility="{Binding DataContext.CanRenderAiExplainButtons, RelativeSource={RelativeSource AncestorType=ListBox}, Converter={StaticResource BooleanToVisibilityConverter}}" />
                      </StackPanel>
                      <TextBlock Margin="0,6,0,0" Foreground="#FF6B7280" Text="{Binding CreatedUtc}" TextWrapping="Wrap" />
                    </StackPanel>
                  </DataTemplate>
                </ListBox.ItemTemplate>
              </ListBox>
              <TextBlock Margin="8,0,8,8"
                         Foreground="#FF6B7280"
                         Text="No blueprints yet. Add one on the left."
                         TextWrapping="Wrap">
                <TextBlock.Style>
                  <Style TargetType="TextBlock">
                    <Setter Property="Visibility" Value="Collapsed" />
                    <Style.Triggers>
                      <DataTrigger Binding="{Binding HasBlueprints}" Value="False">
                        <Setter Property="Visibility" Value="Visible" />
                      </DataTrigger>
                    </Style.Triggers>
                  </Style>
                </TextBlock.Style>
              </TextBlock>
            </GroupBox>
          </Grid>
        </Grid>
      </TabItem>
      <TabItem Header="Execution Environment">
        <Grid Margin="16">
          <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
          </Grid.RowDefinitions>
          <StackPanel>
            <TextBlock Text="Execution environments are user-provided rootfs entries." TextWrapping="Wrap" />
            <TextBlock Margin="0,6,0,0"
                       Foreground="#FF6B7280"
                       Text="{Binding RootFsNotice}"
                       TextWrapping="Wrap" />
          </StackPanel>
          <Grid Grid.Row="1" Margin="0,12,0,0">
            <Grid.ColumnDefinitions>
              <ColumnDefinition Width="240" />
              <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>
            <GroupBox Header="Rootfs Catalog">
              <ListBox Margin="8"
                       ItemsSource="{Binding RootFsCatalog}"
                       SelectedItem="{Binding SelectedRootFs}"
                       DisplayMemberPath="DisplayName" />
            </GroupBox>
            <StackPanel Grid.Column="1" Margin="12,0,0,0">
              <GroupBox Header="Selected Rootfs">
                <StackPanel Margin="12">
                  <TextBlock Text="{Binding ActiveRootFsLabel}" FontWeight="SemiBold" />
                  <TextBlock Margin="0,6,0,0" Text="{Binding ActiveRootFsSource}" TextWrapping="Wrap" />
                  <TextBlock Margin="0,10,0,0" Text="Execution distro source override (URL or local path)" />
                  <TextBox Margin="0,4,0,0" Text="{Binding RootFsSourceOverride, UpdateSourceTrigger=PropertyChanged}" />
                  <TextBlock Margin="0,6,0,0" Foreground="#FF6B7280" Text="{Binding RootFsFallbackNotice}" TextWrapping="Wrap" />
                  <TextBlock Margin="0,6,0,0" Text="{Binding ActiveRootFsLicense}" TextWrapping="Wrap" />
                  <TextBlock Margin="0,6,0,0" Text="{Binding ActiveRootFsNotes}" TextWrapping="Wrap" />
                </StackPanel>
              </GroupBox>
              <GroupBox Margin="0,12,0,0" Header="Resolved Environment">
                <TextBlock Margin="12" Text="{Binding ResolvedExecutionEnvironmentSummary}" TextWrapping="Wrap" />
              </GroupBox>
              <GroupBox Margin="0,12,0,0" Header="Execution Blockers">
                <TextBlock Margin="12" Text="{Binding ExecutionBlockerSummary}" TextWrapping="Wrap" />
              </GroupBox>
              <GroupBox Margin="0,12,0,0" Header="Provider Capabilities">
                <StackPanel Margin="12">
                  <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                    <TextBlock Width="90" Text="Provider" FontWeight="SemiBold" />
                    <TextBlock Width="70" Text="Plan" FontWeight="SemiBold" />
                    <TextBlock Width="80" Text="Execute" FontWeight="SemiBold" />
                    <TextBlock Width="80" Text="Artifacts" FontWeight="SemiBold" />
                  </StackPanel>
                  <ItemsControl ItemsSource="{Binding ProviderCapabilityMatrix}">
                    <ItemsControl.ItemTemplate>
                      <DataTemplate>
                        <StackPanel Orientation="Horizontal" Margin="0,2,0,2">
                          <TextBlock Width="90" Text="{Binding Kind}" />
                          <TextBlock Width="70" Text="{Binding PlanCapability}" />
                          <TextBlock Width="80" Text="{Binding ExecuteCapability}" />
                          <TextBlock Width="80" Text="{Binding ArtifactCapability}" />
                        </StackPanel>
                      </DataTemplate>
                    </ItemsControl.ItemTemplate>
                  </ItemsControl>
                  <TextBlock Margin="0,6,0,0" Foreground="#FF6B7280" Text="Matrix reflects default provider capabilities." />
                </StackPanel>
              </GroupBox>
              <GroupBox Margin="0,12,0,0" Header="Execution Preview">
                <StackPanel Margin="12">
                  <TextBlock Text="{Binding ExecutionPreviewSummary}" TextWrapping="Wrap" />
                  <ItemsControl Margin="0,8,0,0" ItemsSource="{Binding ExecutionPreviewSteps}">
                    <ItemsControl.ItemTemplate>
                      <DataTemplate>
                        <StackPanel Margin="0,2,0,2">
                          <TextBlock Text="{Binding Description}" FontWeight="SemiBold" />
                          <TextBlock Foreground="#FF6B7280" Text="{Binding OwnerLabel}" />
                        </StackPanel>
                      </DataTemplate>
                    </ItemsControl.ItemTemplate>
                  </ItemsControl>
                </StackPanel>
              </GroupBox>
            </StackPanel>
          </Grid>
        </Grid>
      </TabItem>
      <TabItem Header="Tool Execution Records">
        <Grid Margin="16">
          <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
          </Grid.RowDefinitions>
          <StackPanel>
            <TextBlock Text="Tool execution records capture inputs, outputs, and outcomes." TextWrapping="Wrap" />
            <TextBlock Margin="0,6,0,0"
                       Foreground="#FF6B7280"
                       Text="Load a plan to populate records."
                       TextWrapping="Wrap" />
          </StackPanel>
          <Grid Grid.Row="1" Margin="0,12,0,0">
            <Grid.ColumnDefinitions>
              <ColumnDefinition Width="280" />
              <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>
            <StackPanel>
              <StackPanel Orientation="Horizontal">
                <Button Width="120"
                        Content="Replay Plan"
                        Command="{Binding ReplayPlanCommand}"
                        ToolTip="Replay uses recorded steps only."
                        Margin="0,0,8,0" />
                <Button Width="160"
                        Content="Explain This Step"
                        Command="{Binding ExplainSelectedToolExecutionCommand}"
                        ToolTip="Send the selected record to AI Help."
                        Visibility="{Binding CanRenderAiExplainButtons, Converter={StaticResource BooleanToVisibilityConverter}}" />
              </StackPanel>
              <TextBlock Margin="0,12,0,0" Text="Sessions" FontWeight="SemiBold" />
              <ListBox Margin="0,8,0,0"
                       ItemsSource="{Binding ToolExecutionSessions}"
                       SelectedItem="{Binding SelectedToolExecutionSession}"
                       DisplayMemberPath="DisplayName" />
              <TextBlock Margin="0,12,0,0" Text="Records" FontWeight="SemiBold" />
              <TextBlock Margin="0,4,0,0"
                         Foreground="#FF6B7280"
                         Text="No records available yet."
                         TextWrapping="Wrap">
                <TextBlock.Style>
                  <Style TargetType="TextBlock">
                    <Setter Property="Visibility" Value="Collapsed" />
                    <Style.Triggers>
                      <DataTrigger Binding="{Binding HasToolExecutionRecords}" Value="False">
                        <Setter Property="Visibility" Value="Visible" />
                      </DataTrigger>
                    </Style.Triggers>
                  </Style>
                </TextBlock.Style>
              </TextBlock>
              <ListBox Margin="0,8,0,0"
                       ItemsSource="{Binding ToolExecutionRecords}"
                       SelectedItem="{Binding SelectedToolExecutionRecord}"
                       DisplayMemberPath="DisplayName" />
              <TextBlock Margin="0,12,0,0" Text="Compare session" />
              <ComboBox Margin="0,4,0,0"
                        ItemsSource="{Binding ToolExecutionSessions}"
                        SelectedItem="{Binding ComparisonToolExecutionSession}"
                        DisplayMemberPath="DisplayName" />
              <TextBlock Margin="0,12,0,0" Text="Compare record" />
              <ComboBox Margin="0,4,0,0"
                        ItemsSource="{Binding ComparisonToolExecutionRecords}"
                        SelectedItem="{Binding ComparisonToolExecutionRecord}"
                        DisplayMemberPath="DisplayName" />
            </StackPanel>
            <StackPanel Grid.Column="1" Margin="12,0,0,0">
              <TextBlock Text="{Binding ToolExecutionDetailsTitle}" FontWeight="SemiBold" />
              <Border Margin="0,6,0,0"
                      Background="{Binding SelectedToolExecutionRecord.OwnerHighlight}"
                      CornerRadius="4"
                      Padding="4,1"
                      Visibility="{Binding SelectedToolExecutionRecord, Converter={StaticResource NullToVisibilityConverter}}">
                <TextBlock Foreground="White"
                           Text="{Binding SelectedToolExecutionRecord.OwnerBadge}"
                           ToolTip="{Binding SelectedToolExecutionRecord.Owner}" />
              </Border>
              <GroupBox Margin="0,8,0,0" Header="Inputs">
                <TextBlock Margin="8" Text="{Binding SelectedToolExecutionInputs}" TextWrapping="Wrap" />
              </GroupBox>
              <GroupBox Margin="0,8,0,0" Header="Outputs">
                <TextBlock Margin="8" Text="{Binding SelectedToolExecutionOutputs}" TextWrapping="Wrap" />
              </GroupBox>
              <GroupBox Margin="0,8,0,0" Header="Errors">
                <TextBlock Margin="8" Text="{Binding SelectedToolExecutionError}" TextWrapping="Wrap" />
              </GroupBox>
              <GroupBox Margin="0,8,0,0" Header="Diff">
                <TextBlock Margin="8" Text="{Binding ToolExecutionDiffSummary}" TextWrapping="Wrap" />
              </GroupBox>
            </StackPanel>
          </Grid>
        </Grid>
      </TabItem>
      <TabItem Header="Environment">
        <Grid Margin="16">
          <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
          </Grid.RowDefinitions>
          <StackPanel>
            <TextBlock Text="Environment profiles prepare the local sandbox only. This does not affect execution logic." TextWrapping="Wrap" />
            <TextBlock Margin="0,8,0,0" Foreground="DarkRed" Text="{Binding EnvironmentErrorMessage}" TextWrapping="Wrap" />
            <TextBlock Margin="0,4,0,0" Foreground="DarkGreen" Text="{Binding EnvironmentInfoMessage}" TextWrapping="Wrap" />
          </StackPanel>
          <GroupBox Grid.Row="1" Margin="0,12,0,0" Header="Profile">
            <StackPanel Margin="12">
              <ComboBox ItemsSource="{Binding Profiles}" SelectedItem="{Binding SelectedProfile}" DisplayMemberPath="Name" />
              <TextBlock Margin="0,8,0,0" Text="{Binding SelectedProfileDescription}" TextWrapping="Wrap" />
              <ItemsControl Margin="0,8,0,0" ItemsSource="{Binding EnvironmentCapabilities}">
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <TextBlock Text="{Binding}" />
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </StackPanel>
          </GroupBox>
          <StackPanel Grid.Row="2" Margin="0,12,0,0" Orientation="Horizontal">
            <Button Width="160"
                    Content="Apply Environment"
                    Command="{Binding ApplyEnvironmentCommand}"
                    ToolTip="{Binding ApplyEnvironmentDisabledReason}"
                    ToolTipService.ShowOnDisabled="True" />
            <TextBlock Margin="12,0,0,0" VerticalAlignment="Center" Text="{Binding EnvironmentAppliedProfileName}" />
          </StackPanel>
          <GroupBox Grid.Row="3" Margin="0,12,0,0" Header="Last Applied">
            <StackPanel Margin="12">
              <TextBlock Text="{Binding EnvironmentAppliedAtUtc}" />
              <ItemsControl Margin="0,8,0,0" ItemsSource="{Binding EnvironmentAppliedCapabilities}">
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <TextBlock Text="{Binding}" />
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
              <ItemsControl Margin="0,8,0,0" ItemsSource="{Binding EnvironmentCreatedPaths}">
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <TextBlock Text="{Binding}" />
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
              <TextBlock Margin="0,8,0,0" Text="Restart recommended to pick up capability changes."
                         Visibility="{Binding RestartRequired, Converter={StaticResource BooleanToVisibilityConverter}}" />
            </StackPanel>
          </GroupBox>
          <StackPanel Grid.Row="4" Margin="0,12,0,0">
            <Border Background="#FFFDECC8"
                    CornerRadius="4"
                    Margin="0,0,0,8"
                    Padding="8"
                    Visibility="{Binding ScriptPreview, Converter={StaticResource NullToVisibilityConverter}}">
              <TextBlock Text="Preview only until applied." FontWeight="SemiBold" />
            </Border>
            <GroupBox Header="Script Preview" Margin="0,0,0,12" Visibility="{Binding ScriptPreview, Converter={StaticResource NullToVisibilityConverter}}">
              <StackPanel Margin="12">
                <TextBlock Text="{Binding ScriptSearchPath}" TextWrapping="Wrap" />
                <TextBlock Text="{Binding ScriptPreview.Name}" FontWeight="SemiBold" />
                <TextBlock Margin="0,4,0,0" Text="{Binding ScriptPreview.Description}" TextWrapping="Wrap" />
                <TextBlock Margin="0,6,0,0"
                           Text="{Binding ScriptUnsupportedCapabilitiesMessage}"
                           Foreground="DarkRed"
                           TextWrapping="Wrap"
                           Visibility="{Binding ScriptUnsupportedCapabilitiesMessage, Converter={StaticResource NullToVisibilityConverter}}" />
                <GroupBox Margin="0,8,0,0" Header="Validation Summary">
                  <StackPanel Margin="8">
                    <TextBlock Text="{Binding ScriptFolderCountLabel}" />
                    <ItemsControl Margin="0,6,0,0" ItemsSource="{Binding ScriptCapabilities}">
                      <ItemsControl.ItemTemplate>
                        <DataTemplate>
                          <TextBlock Text="{Binding}" />
                        </DataTemplate>
                      </ItemsControl.ItemTemplate>
                    </ItemsControl>
                  </StackPanel>
                </GroupBox>
                <ItemsControl Margin="0,8,0,0" ItemsSource="{Binding ScriptSteps}">
                  <ItemsControl.ItemTemplate>
                    <DataTemplate>
                      <TextBlock Text="{Binding}" />
                    </DataTemplate>
                  </ItemsControl.ItemTemplate>
                </ItemsControl>
                <TextBlock Margin="0,8,0,0"
                           Foreground="#FF6B7280"
                           Text="Scripts are declarative previews. They do not install tools or execute commands."
                           TextWrapping="Wrap" />
                <Button Width="160"
                        Margin="0,8,0,0"
                        Content="Apply Script"
                        Command="{Binding ApplyScriptCommand}"
                        ToolTip="{Binding ApplyScriptDisabledReason}"
                        ToolTipService.ShowOnDisabled="True" />
              </StackPanel>
            </GroupBox>
            <GroupBox Header="Source Control" Visibility="{Binding HasSourceControl, Converter={StaticResource BooleanToVisibilityConverter}}">
              <TextBlock Margin="12" Text="Source control integration is optional and enabled only by the environment profile." TextWrapping="Wrap" />
            </GroupBox>
            <GroupBox Margin="0,12,0,0" Header="Artifact Export" Visibility="{Binding HasArtifactExport, Converter={StaticResource BooleanToVisibilityConverter}}">
              <StackPanel Margin="12">
                <TextBlock Text="Artifact export UI is enabled by the environment profile." TextWrapping="Wrap" />
                <Button Width="160" Margin="0,8,0,0" Content="Export Artifacts" />
              </StackPanel>
            </GroupBox>
          </StackPanel>
        </Grid>
      </TabItem>
      <TabItem Header="Database" Visibility="{Binding HasDatabase, Converter={StaticResource BooleanToVisibilityConverter}}">
        <Grid Margin="16">
          <StackPanel>
            <TextBlock Text="Database intent is optional and never needed for Shoots execution." TextWrapping="Wrap" />
            <GroupBox Margin="0,12,0,0" Header="Intent">
              <StackPanel Margin="12">
                <ListBox ItemsSource="{Binding DatabaseIntents}"
                         SelectedItem="{Binding SelectedDatabaseIntent}"
                         BorderThickness="0"
                         IsEnabled="{Binding HasActiveWorkspace}">
                  <ListBox.ItemTemplate>
                    <DataTemplate>
                      <StackPanel Margin="0,0,0,8">
                        <RadioButton Content="{Binding Name}"
                                     IsChecked="{Binding RelativeSource={RelativeSource AncestorType=ListBoxItem}, Path=IsSelected}" />
                        <TextBlock Margin="24,2,0,0" Text="{Binding Description}" TextWrapping="Wrap" />
                      </StackPanel>
                    </DataTemplate>
                  </ListBox.ItemTemplate>
                </ListBox>
                <TextBlock Margin="0,4,0,0"
                           Foreground="#FF6B7280"
                           Text="Database support is not implemented by design." />
              </StackPanel>
            </GroupBox>
          </StackPanel>
        </Grid>
      </TabItem>
    </TabControl>
  </Grid>
</Window>
